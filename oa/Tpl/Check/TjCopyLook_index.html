<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="/public/images/favicon.ico" type="image/x-icon" />
<link rel="stylesheet" href="/public/css/common.css" type="text/css" />
<link rel="stylesheet" href="/public/css/oa.css" type="text/css" />
<link rel="stylesheet" href="/public/bootstrap/css/bootstrap.css" type="text/css" />
<link rel="stylesheet" href="/public/css/toastr.min.css" type="text/css" />
<script type="text/javascript" src="/public/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="/public/js/common.js"></script>
<script type="text/javascript" src="/public/js/laydate/laydate.js"></script>
<script type="text/javascript">
var AllPlatform = <?php echo (!empty($AllPlatform)?json_encode($AllPlatform):'""');?>;
var citys = <?php echo (!empty($citys)?json_encode($citys):'""');?>;
</script>
<style>
html,body,.tab,.tab-content-wrap,.tab-content-main {height:100%;}
</style>

<title>复制统计</title>
</head>

<body>

<div class="tab">
	<div class="tab-header-wrap">
		<div class="tab-header clearfix">
			<div class="title">
				<i class="glyphicon glyphicon-star"></i>
				<span>复制统计</span>
			</div>
		</div>
	</div>

	<div class="tab-content-wrap">
		<div class="tab-content-main">
			<div class="main-content">

				<ul id="myTab" class="nav nav-tabs">
				    <li class="active">
				        <a href="#CopyWeb" data-toggle="tab">复制着陆页统计</a>
				    </li>
				    <li>
				        <a href="#CopyKeyWords" data-toggle="tab">复制关键字统计</a>
				    </li>
				    <li>
				        <a href="#CopyTime" data-toggle="tab">实时记录</a>
				    </li>
				</ul>
				<div id="myTabContent" class="tab-content">
					<div class="tab-pane in active" id="CopyWeb">
				    	<div class="tab-pane-title clearfix">
							<div class="form-inline search-box">
								<div class="form-group">
									<label>时间：</label>
									<div class="input-group">
										<span class="input-group-btn">
											<input class="btn btn-default" type="button" name="DayTime-button" value="前30天">
											<input class="btn btn-default" type="button" name="DayTime-button" value="前7天">
											<input class="btn btn-default" type="button" name="DayTime-button" value="昨天">
										</span>
										<input type="text" style="width:200px;" class="layui-input form-control" name="DayTime" placeholder=" - ">
										<span class="input-group-btn">
											<input class="btn btn-default" type="button" name="DayTime-button" value="今天">
										</span>
									</div>
								</div>

								<div class="form-group">
									<label>平台：</label>
									<select class="form-control" name="platformID">
										<option>未选择</option>
										<foreach name="AllPlatform" key="key" item="vo">
											<option value="{$key}">{$vo}</option>
										</foreach>
									</select>
								</div>
							</div>
				    	</div>

				    	<div class="tab-pane-content">
				    		<table class="tab-table CopyWeb-table">
				    			<thead>
									<tr>
										<td><input type="checkbox" /></td>
										<td>平台</td>
										<td>着陆页</td>
										<td>复制次数</td>
										<td>访问次数</td>
										<td>操作</td>
									</tr>
								</thead>
								<tbody>

								</tbody>
				    		</table>
				    	</div>

				    	<div class="page-wrap clearfix">
							<div class="page">

							</div>
				    	</div>
					</div>

					<div class="tab-pane" id="CopyKeyWords">
				    	<div class="tab-pane-title clearfix">
							<div class="form-inline search-box">
								<div class="form-group">
									<label>时间：</label>
									<div class="input-group">
										<span class="input-group-btn">
											<input class="btn btn-default" type="button" name="DayTime-button" value="前30天">
											<input class="btn btn-default" type="button" name="DayTime-button" value="前7天">
											<input class="btn btn-default" type="button" name="DayTime-button" value="昨天">
										</span>
										<input type="text" style="width:200px;" class="layui-input form-control" name="DayTime" placeholder=" - ">
										<span class="input-group-btn">
											<input class="btn btn-default" type="button" name="DayTime-button" value="今天">
										</span>
									</div>
								</div>

								<div class="form-group">
									<label>平台：</label>
									<select class="form-control" name="platformID">
										<option>未选择</option>
										<foreach name="AllPlatform" key="key" item="vo">
											<option value="{$key}">{$vo}</option>
										</foreach>
									</select>
								</div>
							</div>
				    	</div>

				    	<div class="tab-pane-content">
				    		<table class="tab-table CopyKeyWords-table">
				    			<thead>
									<tr>
										<td><input type="checkbox" /></td>
										<td></td>
										<td>关键字</td>
										<td>复制次数</td>
									</tr>
								</thead>
								<tbody>

								</tbody>
				    		</table>
				    	</div>

				    	<div class="page-wrap clearfix">
							<div class="page">

							</div>
				    	</div>
					</div>

					<div class="tab-pane" id="CopyTime">
				    	<div class="tab-pane-title clearfix">
							<div class="form-inline search-box">
								<div class="form-group">
									<label>时间：</label>
									<div class="input-group">
										<span class="input-group-btn">
											<input class="btn btn-default" type="button" name="DayTime-button" value="前30天">
											<input class="btn btn-default" type="button" name="DayTime-button" value="前7天">
											<input class="btn btn-default" type="button" name="DayTime-button" value="昨天">
										</span>
										<input type="text" style="width:200px;" class="layui-input form-control" name="DayTime" placeholder=" - ">
										<span class="input-group-btn">
											<input class="btn btn-default" type="button" name="DayTime-button" value="今天">
										</span>
									</div>
								</div>

								<div class="form-group">
									<label>平台：</label>
									<select class="form-control" name="platformID">
										<option>未选择</option>
										<foreach name="AllPlatform" key="key" item="vo">
											<option value="{$key}">{$vo}</option>
										</foreach>
									</select>
								</div>
							</div>
				    	</div>

				    	<div class="tab-pane-content">
				    		<table class="tab-table CopyTime-table">
				    			<thead>
									<tr>
										<td><input type="checkbox" /></td>
										<td>访客ID</td>
										<td>页面地址</td>
										<td>关键字</td>
										<td>来源</td>
										<td>访问时间</td>
										<td>复制详情</td>
									</tr>
								</thead>
								<tbody>

								</tbody>
				    		</table>
				    	</div>

				    	<div class="page-wrap clearfix">
							<div class="page">

							</div>
				    	</div>
					</div>


				</div>

			</div>
		</div>
	</div>
</div>

<div class="modal fade bs-example-modal-lg" id="CopyList-myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">
					&times;
				</button>
				<h4 class="modal-title" id="myModalLabel">
					复制明细
				</h4>
			</div>
			<table class="table table-hover" style="margin-bottom:0px;">
				<thead>
					<tr class="active">
						<td>访客ID</td>
						<td>关键字</td>
						<td>复制详情</td>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
			<div class="modal-body" style="border-top: 1px solid #ddd;">
				<div class="modal-body-content">
			    	<div class="page-wrap clearfix">
						<div class="page">

						</div>
			    	</div>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="tishi"></div>
<div class="J-bg" id="J-bg">
    <div class="J-bg-loading"></div>
    <div class="J-bg-con"></div>
</div>

</body>
</html>
<script type="text/javascript" src="/public/bootstrap/js/bootstrap.js"></script>
<script type="text/javascript" src="/public/js/toastr.min.js"></script>
<script type="text/javascript">
var Action = 'Check/TjCopyLook';
$(document).ready(function(){
	//$("#CopyList-myModal").modal('show');

	$("#myTab li").click(function(){
		setTimeout(function(){
			search_data('/'+Action+'/'+active()+'Page',{"operate":"page"},'');
		},50);
	});
});


/*生成html*/
function list_html(data){
	var html = '';
	if(data['list']!=null && data['list'].length>0){
		var now_active = active();
		if(now_active == 'CopyWeb'){
			for(var i=0;i<data['list'].length;i++){
				html += '<tr data-id="'+data['list'][i]['url']+'"><td><input type="checkbox" /></td><td>'+PlatformIcon(data['list'][i]['platformID'])+'</td><td><a href="'+data['list'][i]['url']+'" target="_blank">'+data['list'][i]['url']+'</a></td><td>'+data['list'][i]['CopyNum']+'</td><td>'+data['list'][i]['NowUrlNum']+'</td><td><button class="btn btn-primary btn-xs"><i class="glyphicon glyphicon-search"></i><span>查看复制明细</span></button></td></tr>';
			}
		}else if(now_active == 'CopyKeyWords'){
			for(var i=0;i<data['list'].length;i++){
				html += '<tr><td><input type="checkbox" /></td><td></td><td>'+data['list'][i]['KeyWords']+'</td><td>'+data['list'][i]['num']+'</td></tr>';
			}
		}else if(now_active == 'CopyTime'){
			for(var i=0;i<data['list'].length;i++){

				var CopyInfo_arr = data['list'][i]['CopyInfo'];
				var CopyInfo = '';
				if(CopyInfo_arr != null && CopyInfo_arr.length > 0){
					for(var c=0;c<CopyInfo_arr.length;c++){
						CopyInfo += CopyInfo_arr[c]['str'] + '（第'+CopyInfo_arr[c]['num']+'个 - '+CopyInfo_arr[c]['times']+'秒）<br>';
					}
				}
				CopyInfo = CopyInfo.replace(/\<br\>$/,'');

				html += '<tr><td><input type="checkbox" /></td><td>'+data['list'][i]['VisitID']+'</td><td><a href="'+data['list'][i]['url']+'" target="_blank">'+data['list'][i]['url']+'</a></td><td>'+data['list'][i]['KeyWords']+'</td><td>'+PlatformIcon(data['list'][i]['platformID'])+'</td><td>'+getDates(data['list'][i]['addtime'],1)+'</td><td>'+CopyInfo+'</td></tr>';
			}
		}
	}

	append($("."+active()+"-table"),html);

	$(".tab-pane.active").find('.page-wrap .page').html(data.page);
	on();

}


/*添加内容到table里面*/
function append(dom,html){
	if(html==''){
		var td_num = dom.find("thead tr td").length;
		html = '<tr><td class="table-null" colspan="'+td_num+'"><i class="glyphicon glyphicon-question-sign"></i><span>暂无数据</span></td></tr>';
	}
	dom.children("tbody").html(html);
}

function on(){
	/*页数*/
	$(".page a").off("click").click(function(e){
		e.preventDefault();
		var num = $(this).attr("href");
		var arr = num.split("/");
		num = arr.pop().replace(".html","");
		if(num!='' && !isNaN(num)){
			search_data('/'+Action+'/'+active()+'Page',{"operate":"page"},num);
			$(".tab-content-main").animate({scrollTop:0},300);
		}
	});

	/*td按钮*/
	$(".tab-table tbody tr td button").off("click").click(function(){
		var button = $(this).text();
		var data = {};
		data.id = $(this).parents("tr").attr("data-id");
		if(data.id!=''){
			if(button=='查看复制明细'){
				data.operate = 'CopyListPage';
				search_data('/'+Action+'/CopyListPage',data,'');
			}
		}else{
			toastr.error("获取的ID为空，无法操作，请联系技术人员");
		}
	});


}

/*处理返回的msg数据*/
function msg_chuli(data,msg,dom){
	chuli("");

	if(msg['msg'] != undefined){
		show_msg(msg);
	}

	if(data.operate=='page'){
		list_html(msg);
	}else if(data.operate == 'CopyListPage'){
		var html = '';
		if(msg['list']!=null && msg['list'].length>0){
			for(var i=0;i<msg['list'].length;i++){

				var CopyInfo_arr = msg['list'][i]['copy'];
				var CopyInfo = '';
				if(CopyInfo_arr != null && CopyInfo_arr.length > 0){
					for(var c=0;c<CopyInfo_arr.length;c++){
						CopyInfo += CopyInfo_arr[c]['str'] + '（第'+CopyInfo_arr[c]['num']+'个 - '+CopyInfo_arr[c]['times']+'秒）<br>';
					}
				}
				CopyInfo = CopyInfo.replace(/\<br\>$/,'');

				html += '<tr><td>'+msg['list'][i]['id']+'</td><td>'+msg['list'][i]['KeyWords']+'</td><td>'+CopyInfo+'</td></tr>';
			}
		}
		append($("#CopyList-myModal table"),html);

		$("#CopyList-myModal").find('.page-wrap .page').html(msg.page);

		$("#CopyList-myModal").find('.page-wrap .page a').off("click").click(function(e){
			e.preventDefault();
			var num = $(this).attr("href");
			var arr = num.split("/");
			num = arr.pop().replace(".html","");
			if(num!='' && !isNaN(num)){
				search_data('/'+Action+'/CopyListPage',data,num);
				$(".tab-content-main").animate({scrollTop:0},300);
			}
		});


		$("#CopyList-myModal").modal('show');
	}
}


/*ajax*/
function post_data(url,data,dom,time){
	chuli("正在处理，请稍后……");
	time = time!=''?time:500;

	setTimeout(function(){
		$.ajax({
			url: '/oa.php'+url,
			type:"post",
			data: data,
			dataType:'json',
			success: function (msg) {
				msg_chuli(data,msg,dom);
			},
			error: function () {
				chuli("");
				toastr.error("提交数据，产生错误");
			}
		})
	},time);
}


/*加载数据*/
search_data('/'+Action+'/'+active()+'Page',{"operate":"page"},'');

$('.search-box').find('select').change(function(){
	search_data('/'+Action+'/'+active()+'Page',{"operate":"page"},'');
});

/*数字转ip*/
function numberToIp(number) {      
    var ip = "";  
    if(number <= 0) {  
        return ip;  
    }  
    var ip3 = (number << 0 ) >>> 24;  
    var ip2 = (number << 8 ) >>> 24;  
    var ip1 = (number << 16) >>> 24;  
    var ip0 = (number << 24) >>> 24  
      
    ip += ip3 + "." + ip2 + "." + ip1 + "." + ip0;  
      
    return ip;     
}

/*搜索*/
function search_data(url,data,page){
	var error = 0;
	$(".tab-pane.active").find('.search-box').find('input[type="text"],select').each(function(){
		var name = $(this).attr("name");
		if(name != null && name != ''){
			var tagName = $(this)[0].tagName;
			var val = $(this).val();
			val = (tagName == 'SELECT' && val == '未选择')?"":val;
			if(val != ''){
				if(name == 'DayTime'){
					var day_arr = val.split(' - ');
					if(day_arr.length>1){
						data.StartTime = Date.parse(new Date(day_arr[0].replace(/\-/g,"/"))) / 1000;
						day_arr[1] = (day_arr[1].replace(/\-/g,"/")) + (' 23:59:59');
						data.EndTime = Date.parse(new Date(day_arr[1].replace(/\-/g,"/"))) / 1000;
						if(data.StartTime > data.EndTime){
							error = 1;
							toastr.error('结束时间不能小于开始时间');
							return false;
						}
					}

				}else{
					data[name] = val;
				}
			}
		}
	});

	if(error == 0){
		page = (page == null || page == '') ? 1 : page;
		post_data(url+'/p/'+page,data,'','0');
	}
}

/*时间处理*/
$('[name="DayTime-button"]').click(function(){
	var str = $(this).val();
	var topdays = new Date();
	if(str == '昨天'){
		topdays.setDate(new Date().getDate() - 1);
		var nowdays = new Date().setDate(new Date().getDate() - 1);
	}else if(str == '前7天'){
		topdays.setDate(new Date().getDate() - 7);
		var nowdays = new Date().setDate(new Date().getDate() - 1);
	}else if(str == '前30天'){
		topdays.setDate(new Date().getDate() - 30);
		var nowdays = new Date().setDate(new Date().getDate() - 1);
	}else if(str == '今天'){
		var nowdays =  topdays;
	}

	var firstDay = getDates(topdays/1000,2);
	var lastDay = getDates((nowdays/1000),2);

	$(".tab-pane.active").find('.search-box input[name="DayTime"]').val(firstDay + " - " + lastDay);
	search_data('/'+Action+'/'+active()+'Page',{"operate":"page"},'');
});
$('[name="DayTime"]').each(function(i){
	$(this).attr('id','DayTime'+i);
	var nowdays = new Date();
	var max = nowdays.getFullYear() + "-" + (nowdays.getMonth()+1) + "-" + nowdays.getDate();
	laydate.render({
		elem: '#DayTime'+i,
		range: true,
		max: max,
		done: function(value, date, endDate){
			search_data('/'+Action+'/'+active()+'Page',{"operate":"page"},'');
		}
	});
});

/*获得当前显示的tabID*/
function active(){
	var id = $(".tab-pane.active").attr("id");
	return id;
}

/*平台标签*/
function PlatformIcon(id){
	var str = ''
	if(id == '0'){
		str = 'default';
	}else if(id == '1'){
		str = 'primary';
	}else if(id == '2'){
		str = 'info';
	}else if(id == '3'){
		str = 'warning';
	}else{
		str = 'danger';
	}
	var html = '<span class="label label-'+str+'">'+((AllPlatform[id] != null && AllPlatform[id] != '') ? AllPlatform[id] : '不详')+'</span>';
	return html;
}

/*处理返回的data数据*/
function show_msg(data){
	if(data.error=='0'){
		/*红色*/
		toastr.error(data.msg);
	}else if(data.error=='1'){
		/*绿色*/
		toastr.success(data.msg);
	}else if(data.error=='2'){
		/*橘黄色*/
		toastr.warning(data.msg);
	}else if(data.error=='4'){
		/*浅蓝色*/
		toastr.info(data.msg);
	}
}


/*计算tab-content距离高度*/
function js_height(){
	var height = $(".tab .tab-header-wrap").height();
	$(".tab .tab-content-wrap").css("padding-top",height+"px");
}
js_height();

/*首行冻结*/
$('.tab-content-main').scroll(function() {

	var header_height = $(".tab .tab-header-wrap").height();
	var thead_top = $('.tab-pane.active .tab-table tbody').prev().offset().top;
	var scrollTop = $(this).scrollTop() || $(this).get(0).scrollTop;
	
	var fixTable = $(".tab-pane.active .tab-pane-content .fixTable");
	if(fixTable.length){
		if(thead_top <= header_height){
			fixTable.css('top',(scrollTop-(scrollTop+thead_top)+header_height)+'px');
		}else{
			fixTable.css('top','0px');
		}
	}else{
		var table_html = $(".tab-pane.active .tab-table").attr("class");
		var thead_html = $(".tab-pane.active .tab-table thead").html();
		html = '<table class="'+table_html+' fixTable"><thead>'+thead_html+'</thead></table>';
		$(".tab-pane.active .tab-pane-content .tab-table").before(html);
		fixTable = $(".tab-pane.active .tab-pane-content .fixTable");
	}
});

</script>