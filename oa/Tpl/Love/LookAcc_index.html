<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="shortcut icon" href="/public/images/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="/public/css/common.css" type="text/css" />
    <link rel="stylesheet" href="/public/css/oa.css" type="text/css" />
    <link rel="stylesheet" href="/public/bootstrap/css/bootstrap.css" type="text/css" />
    <link rel="stylesheet" href="/public/css/toastr.min.css" type="text/css" />
    <script type="text/javascript" src="/public/js/jquery-1.12.4.min.js"></script>
    <script type="text/javascript" src="/public/js/common.js"></script>
    <script type="text/javascript" src="/public/js/laydate/laydate.js"></script>
    <script type="text/javascript">
        var Action = 'Love/{$ActionName}';
    </script>
    <style>
        html,body,.tab,.tab-content-wrap,.tab-content-main {height:100%;}
    </style>
    <title>爱心</title>
</head>

<body>

<div class="tab">
    <div class="tab-header-wrap">
        <div class="tab-header clearfix">
            <div class="tab-search-box">
                <div class="tab-search clearfix">
                    <div class="row">
                        <div class="col-xs-11 search-box">
                            <form class="form-inline">
                                <div class="form-group ">
                                    <label>时间：</label>
                                    <div class="input-group">
										<span class="input-group-btn">
											<input class="btn btn-default" type="button" name="DayTime-button" value="本周">
										</span>
                                        <input type="text" style="width:200px;" class="layui-input form-control" name="DayTime" placeholder=" - ">
                                        <!--<span class="input-group-btn">-->
                                        <!--<input class="btn btn-default" type="button" name="DayTime-button" value="下周">-->
                                        <!--</span>-->
                                        <div style="margin-left: 40px;float: right;font-size: 16px;line-height: 33px;" class="input-group">本月已经累计获得<span style="font-weight: bold;color: #f00">&nbsp;{$a}&nbsp;</span>颗爱心。</div>
                                    </div>
                                </div>
                            </form>
                            <p></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-content-wrap">
        <div class="tab-content-main">
            <div class="main-content">

                <ul id="myTab" class="nav nav-tabs">
                    <li class="active">
                        <a href="#{$ActionName}" data-toggle="tab">收到记录</a>
                    </li>
                </ul>
                <div id="myTabContent" class="tab-content">
                    <div class="tab-pane in active" id="{$ActionName}">
                        <style>
                            td{
                                text-align: center;
                            }
                            .tab .tab-table > thead > tr > td:nth-child(1),.tab .tab-table > tbody > tr > td:nth-child(1) {width:5%;text-align: center;}
                            .tab .tab-table > thead > tr > td:nth-child(2),.tab .tab-table > tbody > tr > td:nth-child(2) {width:25%;text-align: center;}

                        </style>
                        <div class="tab-pane-content">
                            <table class="tab-table">
                                <thead>
                                <tr>
                                    <!--<td><input type="checkbox" /></td>-->
                                    <!--<td>ID</td>-->
                                    <!--<td id="bs" width="5%">排序</td>-->
                                    <td >赠送者</td>
                                    <td >赠送原因</td>
                                    <td width="15%" >赠送时间</td>
                                </tr>
                                </thead>
                                <tbody>

                                </tbody>
                            </table>
                        </div>

                        <div class="page-wrap clearfix">
                            <div class="page">

                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="{$ActionName}-myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="myModalLabel">
                    赠送爱心
                </h4>
            </div>
            <div class="modal-body">
                <div class="modal-body-content">
                    <form class="form-horizontal">
                        <input type="hidden" name="id" value="new" />

                        <div class="form-group">
                            <label class="col-sm-2 control-label">赠予</label>
                            <div class="col-sm-6">
                                <select class="form-control" name="acc_user">
                                    <foreach name="users" item="vo">
                                        <option value="{$vo.username}">{$vo.username}</option>
                                    </foreach>
                                </select>
                                <div class="bitian">*</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-2 control-label">原因</label>
                            <div class="col-sm-6">
                                <textarea rows="7" cols="40" class="form-control" name="reason" placeholder="请简要说明，不要超过50字！"></textarea>
                                <div class="bitian">*</div>
                            </div>
                        </div>

                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消
                </button>
                <button type="button" class="btn btn-success">
                    确定
                </button>
            </div>
        </div>
    </div>
</div>


<div class="tishi"></div>
<div class="J-bg" id="J-bg">
    <div class="J-bg-loading"></div>
    <div class="J-bg-con"></div>
</div>

</body>
</html>
<script type="text/javascript" src="/public/bootstrap/js/bootstrap.js"></script>
<script type="text/javascript" src="/public/js/toastr.min.js"></script>
<script type="text/javascript">
    $(document).ready(function(){
        //$('#ProjectManage-myModal').modal('show');

        /*打开modal窗口*/
        $(".modal_sub").click(function(){
            var now_id = active();
            $("#"+now_id+"-myModal").modal('show');
        });

        /*点击确定按钮*/
        $(".modal .modal-footer button:last-child").click(function(){
            var dom = $(this).parents(".modal");
            Enter(dom);
        });

        $("#myTab li").click(function(){
            setTimeout(function(){
                search_data();
            },50);
        });

        /*搜索按钮点击事件*/
        $("#search-sub").click(function(){
            search_data();
            return false;
        });
    });
    //去左右空格;
    // function trim(s){
    //     return s.replace(/(^\s*)|(\s*$)/g, "");
    // }
    function Enter(dom){
        dom = dom.find('.form-horizontal');

        var data = m_r_val(dom,'input[type="hidden"],input[type="text"],textarea,select','obj');
        //console.log(data);
        if(data.id == ''){
            toastr.error("出错，ID为空，请联系技术");
            return false;
        }

        if(data.reason == ''){
            toastr.error("请填写送心的缘由！");
            return false;
        }

        data['operate'] = 'UpdateAdd';
        //console.log(data);
        post_data("/"+Action+"/"+active()+"Data/",data,'','0');

    }

    /*生成html*/
    function list_html(data){
        console.log(data);
        var html = '';
        if(data['list']!=null && data['list'].length>0){
            var now_active = active();
            if(now_active == 'LookAcc'){
                for(var i=0;i<data['list'].length;i++){
                    html += '<tr data-id="'+data['list'][i]['id']+'">' +
                        // '<td><input type="checkbox" /></td>' +
                        // '<td>'+data['list'][i]['id']+'</td>' +
                        // '<td>'+data['list'][i]['rank']+'</td>' +
                        '<td>'+data['list'][i]['send_user']+'</td>' +
                        '<td>'+data['list'][i]['reason']+'</td>' +
                        '<td>'+getDates(data['list'][i]['send_time'],1)+'</td></tr>';
                }
            }

        }

        /*日期填入*/
        if(data['date']!=null && data['date'].length>0){
            $('.search-box input[name="DayTime"]').val(data['date'][0]+' - '+data['date'][1]);
        }

        append($(".tab-pane.active .tab-table"),html);

        $(".tab-pane.active .page-wrap .page").html(data.page);
        on();

    }

    /*搜索*/
    function search_data(data){
        data = data != null ? data : {};
        // $('#search-box').find('input').each(function(){
        //     var name = $(this).attr("name");
        //     if(name != null && name != ''){
        //         var tagName = $(this)[0].tagName;
        //         var val = $(this).val();
        //         val = (tagName == 'SELECT' && val == '')?"":val;
        //         if(val != ''){
        //             data[name] = val;
        //         }
        //     }
        // });

        data.operate = 'page';
        //data.p = active();
        data.page = (data.page == null || data.page == '') ? 1 :data.page;

        post_data('/'+Action+'/'+active()+'Page/p/'+data.page,data,'','0');
    }

    /*加载数据*/
    search_data();

    function on(){
        /*页数*/
        $(".page a").off("click").click(function(e){
            e.preventDefault();
            var num = $(this).attr("href");
            var arr = num.split("/");
            num = arr.pop().replace(".html","");
            if(num!='' && !isNaN(num)){
                search_data({'page':num});
                $(".tab-content-main").animate({scrollTop:0},300);
            }
        });

        /*td按钮*/
        $(".tab-table tbody tr td button").off("click").click(function(){
            var button = $(this).text();
            var data = {};
            data.id = $(this).parents("tr").attr("data-id");
            if(data.id!=''){
                if(button=='启用' || button=='停用'){
                    var status = button=='启用'?'0':'1';
                    data.operate = 'status';
                    data['status'] = status;
                    post_data('/'+Action+'/'+active()+'Data/',data,$(this),'0');
                }else if(button=='编辑'){
                    data.operate = 'Get';
                    post_data('/'+Action+'/'+active()+'Data/',data,$(this),'0');
                }else if(button=='删除'){
                    var now_active = active();
                    if(confirm("确定删除吗？")){
                        data.operate = 'del';
                        post_data('/'+Action+'/'+active()+'Data/',data,$(this),'0');
                    }else{
                        return false;
                    }
                }
            }else{
                toastr.error("获取的ID为空，无法操作，请联系技术人员");
            }
        });
    }

    /*处理返回的msg数据*/
    function msg_chuli(data,msg,dom){
        console.log(data);
        console.log(msg);
        chuli("");

        if(msg['msg'] != undefined){
            show_msg(msg);
        }

        if(data.operate=='page'){
            list_html(msg);
        }else if(data.operate=='UpdateAdd'){
            if(msg['error']=='1'){
                $('.modal').modal('hide');
                setTimeout(function(){
                    /*获得当前页数*/
                    var page = $(".tab-pane.active .page-wrap .page .current").text();
                    page = (page != null && page != '' && !isNaN(page)) ? page : '1';
                    search_data({'page':page});

                    $(".tab-content-main").animate({scrollTop:0},300);
                },1000);
            }
        }else if(data.operate=='status'){
            if(msg['error']=='1'){
                var html = dom.html();
                if(msg.status=='0'){
                    html = html.replace("启用","停用");
                    html = html.replace("glyphicon-play","glyphicon-stop");
                }else{
                    html = html.replace("停用","启用");
                    html = html.replace("glyphicon-stop","glyphicon-play");
                }
                dom.html(html);
                dom.parents("tr").children("td.status").html(msg.status=='0'?"正常":"停用");

            }
        }else if(data.operate=='Get'){
            if(msg['error']=='1'){

                var now_active = active();

                var dom = $("#"+now_active+"-UpdateModal .form-horizontal");

                dom.find('input[type="text"],input[type="hidden"],textarea,select').each(function(){
                    var name = $(this).attr("name");
                    if(name != undefined){
                        $(this).val(updata_get_data(name,msg));
                    }
                });

                $('#'+active()+'-UpdateModal').modal('show');
            }
        }else if(data.operate=='del'){
            if(msg['error']=='1'){
                dom.parents("tr").hide(500);
            }
        }
    }



    /*获取已选*/
    function checkbox(dom){
        var che_arr = new Array();
        var che_i = 0;
        dom.find('input[type="checkbox"]').each(function(){
            if($(this).prop('checked')){
                che_arr[che_i] = $(this).val();
                che_i++;
            }
        });
        return che_arr;
    }

    /*返回modal里面的值*/
    function m_r_val(id,type,fs){
        if(fs=='obj'){
            var data = {};
            id.find(type).each(function(){
                var name = $(this).attr("name");
                if(name!=undefined && name!=''){
                    val = $(this).val();
                    data[name] = val;
                }
            });
        }else if(fs=='arr'){
            var data =  new Array();
            var i = 0;
            id.find(type).each(function(){
                var name = $(this).attr("name");
                if(name!=undefined && name!=''){
                    var val = $(this).val();
                    data[i] = [name,val];
                    i++;
                }
            });
        }

        return data;
    }

    /*添加内容到table里面*/
    function append(dom,html){
        if(html==''){
            var td_num = dom.find("thead tr td").length;
            html = '<tr><td class="table-null" colspan="'+td_num+'"><i class="glyphicon glyphicon-question-sign"></i><span>暂无数据</span></td></tr>';
        }
        dom.children("tbody").html(html);
    }

    /*编辑model框获取数据*/
    function updata_get_data(name,data){
        var val = '';
        if(data!=null && data){
            for(var i in data){
                if(i == name){
                    return data[i];
                }
            }
        }
        return val;
    }

    /*ajax*/
    function post_data(url,data,dom,time){
        chuli("正在处理，请稍后……");
        time = time!=''?time:500;
        console.log(url);
        //console.log(data);
        //console.log(dom);
        //console.log(time);
        setTimeout(function(){
            $.ajax({
                url: '/oa.php'+url,
                type:"post",
                data: data,
                dataType:'json',
                success: function (msg) {
                    msg_chuli(data,msg,dom);
                },
                error: function (data) {
                    chuli("");
                    toastr.error("提交数据，产生错误");
                }
            })
        },time);
    }

    /*时间处理*/
    $('[name="DayTime-button"]').click(function(){
        var str = $(this).val();
        if(str == '下周'){
            Day_Seach({'day':getTime(-7) + " - " + getTime(-13)});
        }else if(str == '本周'){
            Day_Seach({'day':getTime(0) + " - " + getTime(-6)});
        }
    });

    function getTime(n){
        var now=new Date();
        var year=now.getFullYear();
        var month=now.getMonth()+1;
        var date=now.getDate();
        var day=now.getDay();
        console.log(date);
        if(day!==0){
            n=n+(day-1);
        }else{
            n=n+day;
        }

        if(day){
            if(month>1){
                month=month;
            }else{
                year=year-1;
                month=12;
            }
        }
        now.setDate(now.getDate()-n);
        year=now.getFullYear();
        month=now.getMonth()+1;
        date=now.getDate();
        console.log(n);
        s=year+"-"+(month <10?( '0'+month):month)+ "-"+(date<10?( '0'+date):date);
        return s;
    }

    $('[name="DayTime"]').each(function(i){
        var dom = $(this)[0];
        laydate.render({
            elem: dom,
            range: true,
            done: function(value, date, endDate){
                Day_Seach({'day':value});
            }
        });
    });

    function Day_Seach(data) {
        if (data.day == null || data.day == '') {
            var val = $('[name="DayTime"]').val();
            if (val != '') {
                data.day = val;
            }
        }

        if (data.day != null && data.day != '') {
            var day_arr = data.day.split(' - ');
            if (day_arr.length > 1) {
                data.StartTime = Date.parse(new Date(day_arr[0].replace(/\-/g, "/"))) / 1000;
                data.EndTime = Date.parse(new Date(day_arr[1].replace(/\-/g, "/"))) / 1000;
                if (data.StartTime > data.EndTime) {
                    toastr.error('结束时间不能小于开始时间');
                    return false;
                }
            }
        }
        delete data.day;
        search_data(data);
    }

    /*加载数据*/
    //post_data("/"+Action+"/"+active()+"Page/",{"operate":'page'},'','0');



    /*toastr配置*/
    //toastr.options = {positionClass: "toast-top-center"};

    /*读取字串符json数据*/
    function json_parse_val(obj,key){
        var val = "";
        if(obj!=''){
            obj = JSON.parse(obj);
            if(obj[key]!=null){
                val = obj[key];
            }
        }
        return val;
    }

    function nulls(obj){
        if(obj != null){
            return false;
        }else{
            return true;
        }
    }

    /*读取对象值*/
    function get_obj_val(obj,name,str){
        val = '';

        arr = name.split(".");
        if(arr.length == 1){
            val = !nulls(obj[arr[0]])?obj[arr[0]]:"";
        }else if(arr.length == 2){
            val = (!nulls(obj[arr[0]]) && !nulls(obj[arr[0]][arr[1]]))?obj[arr[0]][arr[1]]:"";
        }else if(arr.length == 3){
            val = (!nulls(obj[arr[0]]) && !nulls(obj[arr[0]][arr[1]]) && !nulls(obj[arr[0]][arr[1]][arr[2]]))?obj[arr[0]][arr[1]][arr[2]]:"";
        }

        val = (val=='' && str != undefined && str!='')?str:val;

        return val;
    }


    /*获得当前显示的tabID*/
    function active(){
        var id = $(".tab-pane.active").attr("id");
        return id;
    }

    /*处理返回的data数据*/
    function show_msg(data){
        console.log(data);
        if(data.error=='0'){
            /*红色*/
            toastr.error(data.msg);
        }else if(data.error=='1'){
            /*绿色*/
            toastr.success(data.msg);
        }else if(data.error=='2'){
            /*橘黄色*/
            toastr.warning(data.msg);
        }else if(data.error=='4'){
            /*浅蓝色*/
            toastr.info(data.msg);
        }
    }


    /*计算tab-content距离高度*/
    function js_height(){
        var height = $(".tab .tab-header-wrap").height();
        $(".tab .tab-content-wrap").css("padding-top",height+"px");
    }
    js_height();

</script>